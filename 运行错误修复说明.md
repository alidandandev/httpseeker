# 运行错误修复说明

## 遇到的错误

运行命令时出现以下错误：

```bash
python httpseeker/cli.py \
  --auth httpseeker/core/auth_yaml/Dz_like_bofa_admin.yaml \
  --env httpseeker/core/run_env/Dz_like_bofa_admin.env \
  --conf_toml httpseeker/core/conf_toml/Dz_like_bofa_admin.toml \
  --run
```

**错误信息：**
```
运行异常：Object of type datetime is not JSON serializable
运行异常通知邮件发送失败: please run connect() first
```

## 问题分析

### 问题 1：datetime 对象无法 JSON 序列化 ⚠️

**位置：** `httpseeker/conftest.py:146`

**原因：**
```python
cells.insert(3, html.td(datetime.now(), class_='col-time'))
```

直接插入了 `datetime.now()` 对象。在某些情况下（如生成 JSON 报告或序列化时），Python 的 datetime 对象无法被直接序列化为 JSON 格式。

**影响：**
- HTML 报告生成失败
- 测试运行中断
- 无法正常完成测试

### 问题 2：邮件发送失败 ⚠️

**位置：** `httpseeker/run.py:305`

**原因：**
- 在捕获异常后尝试发送错误通知邮件
- 但邮件服务器配置为空（`Dz_like_bofa_admin.toml` 中 `email.host = ''`）
- 导致 SMTP 连接失败

**影响：**
- 显示无用的错误信息
- 干扰真正错误的诊断

## 修复内容

### ✅ 修复 1：datetime 格式化

**文件：** `httpseeker/conftest.py:146`

**修复前：**
```python
cells.insert(3, html.td(datetime.now(), class_='col-time'))
```

**修复后：**
```python
cells.insert(3, html.td(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), class_='col-time'))
```

**说明：**
- 将 `datetime.now()` 对象转换为字符串格式
- 使用 `strftime()` 格式化为 `YYYY-MM-DD HH:MM:SS`
- 确保可以正常序列化

### ✅ 修复 2：邮件发送错误处理

**文件：** `httpseeker/run.py:301-313`

**修复前：**
```python
except Exception as e:
    log.error(f'运行异常：{e}')
    import traceback

    SendEmail({'error': traceback.format_exc()}).send_error()
```

**修复后：**
```python
except Exception as e:
    log.error(f'运行异常：{e}')
    import traceback

    # 只在邮件配置有效时才发送错误通知
    if httpseeker_config.EMAIL_SEND and httpseeker_config.EMAIL_SERVER:
        try:
            SendEmail({'error': traceback.format_exc()}).send_error()
        except Exception as email_error:
            log.debug(f'邮件发送失败: {email_error}')

    # 打印完整的错误堆栈以便调试
    log.error(f'完整错误信息:\n{traceback.format_exc()}')
```

**改进：**
- ✅ 检查邮件配置是否有效再发送
- ✅ 捕获邮件发送异常，避免干扰主要错误
- ✅ 打印完整错误堆栈，方便调试

## 验证修复

现在运行命令应该不会再出现这些错误：

```bash
python httpseeker/cli.py \
  --auth httpseeker/core/auth_yaml/Dz_like_bofa_admin.yaml \
  --env httpseeker/core/run_env/Dz_like_bofa_admin.env \
  --conf_toml httpseeker/core/conf_toml/Dz_like_bofa_admin.toml \
  --run
```

**预期输出：**
```
📋 当前项目: Dz_like_bofa_admin
😝 用例已经很完善了, 添加新测试用例数据后再来生成吧~
>>> 自动注册功能已禁用
collected 45 items

# 正常运行测试...
```

## 相关配置

### 邮件配置说明

如果你想启用邮件通知功能，需要在 `Dz_like_bofa_admin.toml` 中配置：

```toml
[email]
host = 'smtp.example.com'        # SMTP 服务器地址
port = 465                        # SMTP 端口
user = 'your-email@example.com'  # 发件人邮箱
password = 'your-password'        # 邮箱密码或授权码
receiver = 'receiver@example.com' # 收件人邮箱
ssl = true                        # 是否使用 SSL
send = true                       # 是否启用邮件发送
```

### 禁用邮件通知（当前配置）

```toml
[email]
host = ''
port = 465
user = ''
password = ''
receiver = ''
ssl = true
send = false  # 已禁用
```

## 修复的文件列表

1. ✅ `httpseeker/conftest.py` - 修复 datetime 序列化问题
2. ✅ `httpseeker/run.py` - 改进错误处理和邮件发送逻辑

## 注意事项

1. **datetime 序列化**
   - 在 Python 中，datetime 对象不能直接转换为 JSON
   - 需要先转换为字符串或时间戳格式
   - 常用格式：`strftime('%Y-%m-%d %H:%M:%S')`

2. **邮件配置**
   - 如果不需要邮件通知，设置 `send = false`
   - 如果需要启用，必须配置完整的 SMTP 信息
   - 建议使用应用专用密码而非真实密码

3. **错误调试**
   - 现在会打印完整的错误堆栈信息
   - 方便快速定位问题
   - 不会被无关的邮件错误干扰

## 总结

✅ **已修复 datetime 序列化错误** - 测试可以正常运行
✅ **已改进邮件错误处理** - 不会显示无用的错误信息
✅ **增强错误日志** - 打印完整错误堆栈方便调试

现在可以正常运行 `Dz_like_bofa_admin` 项目的测试了！
